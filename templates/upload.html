<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Upload de Documentos - Madruga Contabilidade</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .partner-section {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 30px;
            background: #fff;
        }

        .partner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .file-status {
            font-size: 0.9rem;
            color: var(--success);
            display: none;
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <h1>Envio de Documentos</h1>
            <p>Envie os documentos para extra√ß√£o autom√°tica ou pule para preencher manualmente.</p>
        </div>
    </header>

    <div class="container">
        <form action="/process" method="post" enctype="multipart/form-data" id="multistepForm">
            <input type="hidden" name="partner_count" value="{{ partner_count }}">

            {% for i in range(partner_count) %}
            <div class="partner-section">
                <div class="partner-header">
                    <h2>S√≥cio {{ i + 1 }}</h2>
                    <span class="file-status" id="status-{{ i }}">Arquivo Selecionado ‚úì</span>
                </div>

                <div class="upload-zone" id="dropZone-{{ i }}"
                    onclick="document.getElementById('file-{{ i }}').click()">
                    <p>üìÑ Documento de Identidade do S√≥cio {{ i + 1 }}</p>
                    <p style="font-size: 0.8rem; color: var(--text-grey);">(CNH, CIN, RG)</p>
                    <input type="file" name="files_partner_{{ i }}[]" id="file-{{ i }}" style="display: none;" multiple
                        onchange="updateStatus({{ i }})">
                </div>

                <!-- Address Proof Zone -->
                <div class="upload-zone" id="dropZone-addr-{{ i }}"
                    onclick="document.getElementById('file-addr-{{ i }}').click()"
                    style="margin-top: 15px; padding: 40px;">
                    <p>üìç Comprovante de Endere√ßo (Opcional)</p>
                    <p style="font-size: 0.8rem; color: var(--text-grey);">(Conta de luz, √°gua, telefone, banco)</p>
                    <input type="file" name="files_address_{{ i }}[]" id="file-addr-{{ i }}" style="display: none;"
                        onchange="updateStatus('addr-{{ i }}')">
                </div>
                <span class="file-status" id="status-addr-{{ i }}" style="margin-top: 5px;">Comprovante Selecionado
                    ‚úì</span>
            </div>
            {% endfor %}


            <!-- Company Docs (Optional) -->
            <div class="partner-section">
                <div class="partner-header">
                    <h2>Documentos da Empresa (Opcional)</h2>
                    <span class="file-status" id="status-company">Arquivo Selecionado ‚úì</span>
                </div>
                <div class="upload-zone" id="dropZone-company"
                    onclick="document.getElementById('file-company').click()">
                    <p>Contrato Social anterior, Cart√£o CNPJ, etc.</p>
                    <input type="file" name="files_company[]" id="file-company" style="display: none;" multiple
                        onchange="updateStatus('company')">
                </div>
            </div>

            <div style="text-align: center; margin-bottom: 50px;">
                <!-- Success Banner (hidden by default) -->
                <div id="successBanner" class="success-banner"
                    style="display: none; max-width: 500px; margin: 0 auto 20px auto;">
                    <span class="success-banner-icon">‚úÖ</span>
                    <span class="success-banner-text" id="bannerText">Documentos selecionados com sucesso!</span>
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn"
                    style="padding: 18px 40px; font-size: 1.2rem;">
                    <span class="btn-text">Processar e Gerar Formul√°rio ‚Üí</span>
                </button>
                <div id="progressContainer" class="progress-bar-container"
                    style="display: none; max-width: 300px; margin: 15px auto 0;">
                    <div class="progress-bar progress-bar-indeterminate"></div>
                </div>
                <p id="statusText" style="margin-top: 10px; color: var(--text-grey); font-size: 0.9rem;">
                    Nota: Se n√£o enviar documentos, o formul√°rio ser√° gerado em branco.
                </p>
            </div>
        </form>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // Toast notification system
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Track total files selected
        let totalFilesSelected = 0;

        function updateStatus(id) {
            const input = document.getElementById('file-' + id);
            const status = document.getElementById('status-' + id);
            const zone = document.getElementById('dropZone-' + id);

            if (input.files.length > 0) {
                status.style.display = 'block';
                status.textContent = input.files.length + " arquivo(s) selecionado(s)";
                zone.style.borderColor = 'var(--success)';
                zone.style.background = '#f0fff4';

                // Show toast notification
                showToast(`${input.files.length} arquivo(s) adicionado(s) para ${id === 'company' ? 'Empresa' : 'S√≥cio ' + (parseInt(id) + 1)}`, 'success');

                // Update total and show banner
                updateTotalFiles();
            }
        }

        function updateTotalFiles() {
            const allInputs = document.querySelectorAll('input[type="file"]');
            let total = 0;
            allInputs.forEach(input => {
                total += input.files.length;
            });

            if (total > 0) {
                const banner = document.getElementById('successBanner');
                const bannerText = document.getElementById('bannerText');
                banner.style.display = 'flex';
                bannerText.textContent = `${total} documento(s) pronto(s) para processamento`;
            }
        }

        // Form submission with loading state
        document.getElementById('multistepForm').addEventListener('submit', function (e) {
            const submitBtn = document.getElementById('submitBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const progressContainer = document.getElementById('progressContainer');
            const statusText = document.getElementById('statusText');

            // Activate loading state
            submitBtn.classList.add('btn-loading');
            btnText.textContent = 'Processando...';
            btnText.style.opacity = '1';
            progressContainer.style.display = 'block';
            statusText.textContent = 'Extraindo dados com IA... isso pode levar alguns segundos.';
            statusText.style.color = 'var(--accent-cyan-end)';

            // Show info toast
            showToast('Processando documentos com IA...', 'info');
        });

        // Add drag and drop logic for all zones
        const zones = document.querySelectorAll('.upload-zone');
        zones.forEach(zone => {
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.style.borderColor = 'var(--accent-cyan-end)';
                zone.style.background = '#f0f8ff';
            });
            zone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                zone.style.borderColor = 'var(--border-color)';
                zone.style.background = '#fafafa';
            });
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                const inputId = zone.id.replace('dropZone-', 'file-');
                const updateId = inputId.replace('file-', '');
                const input = document.getElementById(inputId);

                if (e.dataTransfer.files.length) {
                    input.files = e.dataTransfer.files;
                    updateStatus(updateId);
                }
                zone.style.borderColor = 'var(--success)';
                zone.style.background = '#f0fff4';
            });
        });
    </script>
</body>

</html>