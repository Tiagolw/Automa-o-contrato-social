<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload de Documentos - Madruga Contabilidade</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .upload-section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .upload-section h3 {
            color: var(--primary);
            margin-bottom: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .file-input-group {
            margin-bottom: 16px;
        }

        .file-input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        input[type="file"] {
            display: block;
            width: 100%;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background: #fafafa;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        input[type="file"]:hover {
            border-color: var(--accent);
        }

        /* Progress Modal Styles */
        .status-text {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .sub-status {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .btn-secondary {
            background-color: #f8f9fa;
            color: var(--text-primary);
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background-color: #e2e6ea;
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <h1>Upload de Documentos</h1>
            <p>Envie os documentos para processamento inteligente</p>
        </div>
    </header>

    <div class="container">
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="hidden" id="partnerTotal" value="{{ partner_count }}">

            <div class="card" style="margin-bottom: 30px; border-left: 5px solid var(--primary);">
                <h2 style="color: var(--primary); margin-bottom: 10px;">Configuração: {{ partner_count }} Sócios
                </h2>
                <p>Por favor, envie os documentos de <strong>cada sócio</strong> separadamente abaixo.</p>
            </div>

            {% for i in range(partner_count) %}
            <div class="upload-section">
                <h3>Sócio {{ i + 1 }}</h3>
                <div class="file-input-group">
                    <label class="file-input-label">Documentos de Identidade (CNH, RG, CIN)</label>
                    <input type="file" name="files_partner_{{ i }}[]" multiple accept=".pdf,.png,.jpg,.jpeg">
                    <small>Frente e verso se necessário. Pode selecionar múltiplos arquivos.</small>
                </div>
                <div class="file-input-group">
                    <label class="file-input-label">Comprovante de Endereço</label>
                    <input type="file" name="files_address_{{ i }}[]" accept=".pdf,.png,.jpg,.jpeg">
                    <small>Conta de luz, água, etc.</small>
                </div>
            </div>
            {% endfor %}

            <div class="upload-section" style="border-left: 5px solid var(--accent);">
                <h3>Dados da Empresa</h3>
                <div class="file-input-group">
                    <label class="file-input-label">Cartão CNPJ ou Contrato Social Anterior (Opcional)</label>
                    <input type="file" name="files_company[]" multiple accept=".pdf,.png,.jpg,.jpeg">
                    <small>Se for alteração ou para aproveitar dados.</small>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px; margin-bottom: 60px;">
                <button type="button" class="btn btn-primary" onclick="startProcessing()"
                    style="padding: 15px 50px; font-size: 1.2rem;">
                    Processar Documentos ⚡
                </button>
                <br><br>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                    ← Voltar ao Início
                </a>
            </div>
        </form>
    </div>

    <div class="modal-overlay" id="processingModal">
        <div class="modal">
            <div class="spinner"></div>
            <div class="status-text" id="statusText">Iniciando processamento...</div>
            <div class="sub-status" id="subStatus">Preparando arquivos...</div>
            <p style="font-size: 0.8rem; color: #888; margin-top: 15px;">
                Isso pode levar alguns minutos. Por favor, <strong>não feche a página</strong>.
            </p>
        </div>
    </div>

    <!-- Confirm No Docs Modal -->
    <div class="modal-overlay" id="noDocsModal" style="display: none;">
        <div class="modal">
            <div class="status-text">Nenhum documento selecionado</div>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Você não selecionou nenhum documento para upload. Deseja continuar e preencher os dados manualmente?
            </p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeNoDocsModal()">Voltar e Inserir</button>
                <button class="btn btn-primary" onclick="proceedWithoutDocs()">Continuar Mesmo Assim</button>
            </div>
        </div>
    </div>

    <script>
        async function startProcessing() {
            const modal = document.getElementById('processingModal');
            const statusText = document.getElementById('statusText');
            const subStatus = document.getElementById('subStatus');
            const progressBar = document.getElementById('progressBar');
            const partnerCount = parseInt(document.getElementById('partnerTotal').value);

            // Check if any files are selected
            const fileInputs = document.querySelectorAll('input[type="file"]');
            let hasFiles = false;
            fileInputs.forEach(input => {
                if (input.files.length > 0) hasFiles = true;
            });

            if (!hasFiles) {
                // Show custom modal instead of alert
                document.getElementById('noDocsModal').style.display = 'flex';
                return;
            }

            modal.style.display = 'flex';

            // Consolidated data structure
            let finalData = {
                partners: [],
                company: {}
            };

            // Calculate total tasks for progress bar
            let totalFiles = 0;
            fileInputs.forEach(input => totalFiles += input.files.length);
            if (totalFiles === 0) totalFiles = 1; // Prevent div by zero

            let processedFiles = 0;

            function updateStatus(msg, subMsg) {
                if (msg) statusText.innerText = msg;
                if (subMsg) subStatus.innerText = subMsg;
            }

            try {
                // 1. Process Partners
                for (let i = 0; i < partnerCount; i++) {
                    let partnerData = { id: i };

                    // Identity Docs
                    const idInput = document.querySelector(`input[name="files_partner_${i}[]"]`);
                    if (idInput && idInput.files.length > 0) {
                        updateStatus(`Processando Sócio ${i + 1}`, "Lendo documentos de identidade...");

                        for (let file of idInput.files) {
                            subStatus.innerText = `Analisando: ${file.name}`;
                            const result = await uploadSingleFile(file, 'identity', i);
                            // Merge results
                            console.log(`[DEBUG] Sócio ${i} identity result:`, result);
                            partnerData = { ...partnerData, ...result };
                            processedFiles++;
                        }
                    }

                    // Address Docs
                    const addrInput = document.querySelector(`input[name="files_address_${i}[]"]`);
                    if (addrInput && addrInput.files.length > 0) {
                        updateStatus(`Processando Sócio ${i + 1}`, "Lendo comprovante de endereço...");

                        for (let file of addrInput.files) {
                            subStatus.innerText = `Analisando: ${file.name}`;
                            const result = await uploadSingleFile(file, 'address', i);
                            // Merge address specifically
                            console.log(`[DEBUG] Sócio ${i} address result:`, result);
                            if (result.address) partnerData.address = result.address;
                            else if (result.full_address) partnerData.address = result.full_address;

                            processedFiles++;
                        }
                    }

                    finalData.partners.push(partnerData);
                }

                // 2. Process Company
                const companyInput = document.querySelector('input[name="files_company[]"]');
                if (companyInput && companyInput.files.length > 0) {
                    updateStatus("Processando Empresa", "Lendo documentos da empresa...");

                    for (let file of companyInput.files) {
                        subStatus.innerText = `Analisando: ${file.name}`;
                        const result = await uploadSingleFile(file, 'company', null);
                        console.log(`[DEBUG] Company result:`, result);
                        finalData.company = { ...finalData.company, ...result };
                        processedFiles++;
                    }
                }

                // 3. Finalize
                updateStatus("Finalizando...", "Consolidando dados...");
                console.log("[DEBUG] Consolidated Final Data:", finalData);
                await submitConsolidatedData(finalData);

            } catch (error) {
                console.error("Erro no processamento:", error);
                alert("Ocorreu um erro ao processar os documentos: " + error.message);
                modal.style.display = 'none';
            }
        }

        async function uploadSingleFile(file, type, partnerIndex) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', type);
            if (partnerIndex !== null) formData.append('partner_index', partnerIndex);

            try {
                const response = await fetch('/api/extract-document', {
                    method: 'POST',
                    body: formData
                });

                const contentType = response.headers.get("content-type");
                if (!response.ok) {
                    let errorMessage = `Erro ${response.status}: ${response.statusText}`;
                    if (contentType && contentType.includes("application/json")) {
                        const errData = await response.json();
                        errorMessage = errData.error || errorMessage;
                    } else {
                        const text = await response.text();
                        console.error("Server returned non-JSON error:", text);
                        errorMessage += " (Resposta do servidor não é JSON)";
                    }
                    throw new Error(errorMessage);
                }

                if (contentType && contentType.includes("application/json")) {
                    return await response.json();
                } else {
                    console.warn("Expected JSON but got:", contentType);
                    throw new Error("O servidor não retornou um JSON válido.");
                }
            } catch (err) {
                console.error("Fetch error in uploadSingleFile:", err);
                throw err;
            }
        }

        async function submitConsolidatedData(data) {
            try {
                const response = await fetch('/process-json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.includes("text/html")) {
                        const html = await response.text();
                        document.open();
                        document.write(html);
                        document.close();
                        history.pushState({}, "Dados Extraídos", "/form");
                    } else {
                        // If it's not HTML, maybe it's a redirect or JSON message
                        const result = await response.text();
                        console.log("Unexpected response format:", result);
                        window.location.href = "/"; // Fallback to index
                    }
                } else {
                    const contentType = response.headers.get("content-type");
                    let msg = `Erro ${response.status}`;
                    if (contentType && contentType.includes("application/json")) {
                        const err = await response.json();
                        msg = err.error || msg;
                    }
                    throw new Error(msg || "Falha ao salvar dados processados");
                }
            } catch (err) {
                console.error("Error in submitConsolidatedData:", err);
                throw err;
            }
        }

        function closeNoDocsModal() {
            document.getElementById('noDocsModal').style.display = 'none';
        }

        async function proceedWithoutDocs() {
            closeNoDocsModal();
            const modal = document.getElementById('processingModal');
            const statusText = document.getElementById('statusText');
            const subStatus = document.getElementById('subStatus');

            modal.style.display = 'flex';
            statusText.innerText = "Criando rascunho...";
            subStatus.innerText = "Preparando formulário vazio...";

            const partnerCount = parseInt(document.getElementById('partnerTotal').value);

            // Create empty structure
            let finalData = {
                partners: [],
                company: {}
            };

            // Add empty partner placeholders so the backend knows how many to create
            for (let i = 0; i < partnerCount; i++) {
                finalData.partners.push({ id: i });
            }

            await submitConsolidatedData(finalData);
        }
    </script>
</body>

</html>